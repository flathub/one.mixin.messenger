id: one.mixin.messenger
runtime: org.freedesktop.Platform
runtime-version: '22.08'
sdk: org.freedesktop.Sdk
command: mixin_desktop
finish-args:
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  - --device=dri
  - --socket=pulseaudio
  - --share=network
  - --filesystem=home
  - --talk-name=org.freedesktop.Notifications
  - --talk-name=org.kde.StatusNotifierWatcher

cleanup-commands:
  - mkdir -p ${FLATPAK_DEST}/lib/webview

cleanup:
  - /include
  - /lib/pkgconfig
  - /share/gir-1.0

modules:
  - name: mixin_desktop
    buildsystem: simple
    build-commands:
    - install -Dm755 mixin_desktop /app/mixin_desktop/mixin_desktop
    - cp -r data /app/mixin_desktop/data
    - cp -r lib /app/mixin_desktop/lib
    - mkdir -p /app/bin
    - ln -s /app/mixin_desktop/mixin_desktop /app/bin/mixin_desktop
    - install -Dm644 mixin_desktop.png /app/share/icons/hicolor/256x256/apps/one.mixin.messenger.png
    - install -Dm644 one.mixin.messenger.desktop -t /app/share/applications/
    - install -Dm644 one.mixin.messenger.metainfo.xml -t /app/share/appdata/
    sources:
      - type: file
        path: one.mixin.messenger.desktop
      - type: file
        path: mixin_desktop.png
      - type: archive
        archive-type: tar
        url: https://github.com/MixinNetwork/flutter-app/releases/download/v0.38.3/mixin_desktop_linux_amd64_portable.tar.gz
        sha256: 4c9c3b7fac8452bcb447288df694cda908ac7f3b6c1a4b9e3b9795e85d6d7ea7
      - type: file
        path: one.mixin.messenger.metainfo.xml
  
  - name: webkitgtk
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=None
      - -DPORT=GTK
      - -DUSE_LIBSECRET=OFF
      - -DUSE_WOFF2=OFF
      - -DUSE_WPE_RENDERER=OFF
      - -DENABLE_BUBBLEWRAP_SANDBOX=OFF
      - -DENABLE_GAMEPAD=OFF
      - -DENABLE_INTROSPECTION=OFF
      - -DENABLE_SPELLCHECK=OFF
    sources:
      - type: archive
        url: https://webkitgtk.org/releases/webkitgtk-2.38.3.tar.xz
        sha256: 41f001d1ed448c6936b394a9f20e4640eebf83a7f08262df28504f7410604a5a
        x-checker-data:
          type: html
          url: https://webkitgtk.org/releases/
          version-pattern: LATEST-STABLE-(\d[\.\d]+\d)
          url-template: https://webkitgtk.org/releases/webkitgtk-$version.tar.xz
